<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LGS Hazƒ±rlƒ±k (G√∂rsel Destekli)</title>
    <style>
        /* --- TASARIM --- */
        :root {
            --primary: #4F46E5; --secondary: #10B981; --danger: #EF4444; 
            --warning: #F59E0B; --bg: #F3F4F6; --text: #1F2937; --empty: #6B7280;
            --selected: #3B82F6;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }

        .app-container {
            background: white; width: 100%; max-width: 500px;
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden; position: relative; min-height: 700px;
            display: flex; flex-direction: column;
        }

        /* Y√úKLENƒ∞YOR EKRANI */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-text { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .error-log { 
            font-family: monospace; font-size: 0.75rem; color: #dc2626; 
            background: #fee2e2; padding: 10px; border-radius: 5px; 
            width: 90%; max-height: 100px; overflow-y: auto; text-align: left;
            margin-top: 10px; display: none;
        }

        /* EKRANLAR */
        .screen { display: none; padding: 30px; flex: 1; flex-direction: column; align-items: center; justify-content: center; text-align: center; animation: fadeIn 0.4s ease; position: relative; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { color: var(--primary); margin-bottom: 20px; }
        
        .btn {
            background-color: var(--primary); color: white; border: none;
            padding: 15px 30px; border-radius: 12px; font-size: 1.1rem;
            cursor: pointer; width: 100%; margin: 8px 0; font-weight: bold;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-subject { background-color: white; color: var(--text); border: 2px solid #E5E7EB; }
        .btn-subject:hover { border-color: var(--primary); color: var(--primary); background: #EEF2FF; }

        /* ≈ûIK BUTONLARI */
        .btn-option {
            background-color: #F9FAFB; color: var(--text); border: 2px solid #E5E7EB;
            text-align: left; position: relative; transition: all 0.2s;
        }
        .btn-option:hover { background-color: #EEF2FF; border-color: #C7D2FE; }
        .btn-option.selected { 
            background-color: #EFF6FF; border-color: var(--selected); color: var(--selected); 
            box-shadow: 0 0 0 2px var(--selected) inset; font-weight: bold;
        }
        .btn-option.correct-review { background-color: #D1FAE5; border-color: var(--secondary); color: var(--secondary); }
        .btn-option.wrong-review { background-color: #FEE2E2; border-color: var(--danger); color: var(--danger); }
        .btn-option:disabled { cursor: default; }

        /* NAVƒ∞GASYON BUTONLARI */
        .nav-buttons {
            display: flex; justify-content: space-between; width: 100%; margin-top: 20px; gap: 10px;
        }
        .btn-nav {
            background-color: #E5E7EB; color: #374151; flex: 1; padding: 12px;
            font-size: 1rem; border-radius: 10px; border: none; cursor: pointer;
        }
        .btn-nav:hover { background-color: #D1D5DB; }
        .btn-nav.primary { background-color: var(--primary); color: white; }
        .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }

        /* √úST √áUBUK */
        .top-bar { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; font-weight: bold; font-size: 1.1rem; align-items: center; }
        .timer-box { color: var(--danger); } .score-box { color: var(--primary); }
        
        .home-btn-corner {
            position: absolute; top: 15px; right: 15px;
            background: #F3F4F6; color: #666; border: none;
            width: 35px; height: 35px; border-radius: 50%;
            cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }
        .home-btn-corner:hover { background: #E5E7EB; color: #333; }

        .hint-btn {
            background: none; border: none; color: var(--warning); cursor: pointer;
            font-size: 0.95rem; text-decoration: underline; margin-top: 15px;
            display: flex; align-items: center; gap: 5px; font-weight: bold; align-self: flex-start;
        }

        /* SONU√á ƒ∞STATƒ∞STƒ∞KLERƒ∞ */
        .stats-container {
            display: flex; gap: 10px; width: 100%; justify-content: center; margin: 20px 0;
        }
        .stat-box {
            flex: 1; padding: 15px 5px; border-radius: 10px; text-align: center;
            color: white; font-weight: bold; display: flex; flex-direction: column; gap: 5px;
            cursor: default; transition: transform 0.2s;
        }
        .stat-box.clickable { cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-box.clickable:hover { transform: translateY(-3px); }
        .stat-box.correct { background-color: var(--secondary); }
        .stat-box.wrong { background-color: var(--danger); }
        .stat-box.empty { background-color: var(--empty); }
        .stat-box span { font-size: 1.5rem; }

        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 20px; width: 85%;
            text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .modal-content img { max-width: 100%; border-radius: 10px; margin: 15px 0; border: 1px solid #ddd; }

        .question-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 15px; width: 100%; text-align: left; line-height: 1.6; }
        .progress-bar { width: 100%; height: 8px; background: #E5E7EB; border-radius: 4px; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 4px; transition: width 0.3s; }
        
        .review-banner {
            background-color: #FEF3C7; color: #D97706; padding: 10px; width: 100%;
            text-align: center; font-weight: bold; font-size: 0.9rem; margin-bottom: 15px;
            border-radius: 8px; display: none;
        }
    </style>
</head>
<body>

    <div class="app-container">

        <!-- Y√úKLEME EKRANI -->
        <div id="loading-screen">
            <div class="spinner"></div>
            <h2>Baƒülantƒ± Kuruluyor</h2>
            <p id="status-text" class="status-text">Sunucuya baƒülanƒ±lƒ±yor...</p>
            <div id="error-log" class="error-log"></div>
            <button id="retry-btn" class="btn" style="display:none; background:#4b5563; font-size:0.9rem;" onclick="location.reload()">üîÑ Tekrar Dene</button>
            <button id="demo-btn" class="btn" style="display:none; background:#f59e0b; font-size:0.9rem;" onclick="useDemoData()">‚ö†Ô∏è Demo Modu ile A√ß</button>
        </div>

        <!-- ANA MEN√ú -->
        <div id="home-screen" class="screen">
            <h1>üéì LGS Hazƒ±rlƒ±k</h1>
            <p>Ba≈ülamak i√ßin bir ders se√ßin:</p>
            <br>
            <div id="subject-buttons"></div>
            <div style="margin-top:20px; font-size:0.8rem; color:#999;">
                Toplam <span id="total-q-count">0</span> soru y√ºklendi.
            </div>
        </div>

        <!-- SINAV EKRANI -->
        <div id="quiz-screen" class="screen">
            <button class="home-btn-corner" onclick="confirmHome()" title="Ana Men√º">üè†</button>
            <div id="review-banner" class="review-banner">üìù Yanlƒ±≈ü Cevap ƒ∞nceleme Modu</div>
            <div class="top-bar">
                <div class="timer-box">‚è±Ô∏è <span id="time-display">00</span></div>
                <div class="score-box" style="visibility: hidden;">Puan: <span id="score-display">0</span></div>
            </div>
            <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
            <div class="question-text" id="question-text"></div>
            <div id="options-container" style="width: 100%;"></div>
            <button class="hint-btn" onclick="showHint()">üí° ƒ∞pucu</button>
            <div class="nav-buttons">
                <button class="btn-nav" id="prev-btn" onclick="prevQuestion()">‚¨ÖÔ∏è √ñnceki</button>
                <button class="btn-nav primary" id="next-btn" onclick="nextQuestion()">Sonraki ‚û°Ô∏è</button>
            </div>
        </div>

        <!-- SONU√á EKRANI -->
        <div id="result-screen" class="screen">
            <h1>üèÅ Sƒ±nav Tamamlandƒ±!</h1>
            <div class="stats-container">
                <div class="stat-box correct"><span id="res-correct">0</span> Doƒüru</div>
                <div class="stat-box wrong" id="wrong-box" onclick="startReview()" title="Yanlƒ±≈ülarƒ±nƒ± incelemek i√ßin tƒ±kla">
                    <span id="res-wrong">0</span> Yanlƒ±≈ü
                    <div style="font-size:0.7rem; opacity:0.8; margin-top:2px;">(ƒ∞ncelemek i√ßin tƒ±kla)</div>
                </div>
                <div class="stat-box empty"><span id="res-empty">0</span> Bo≈ü</div>
            </div>
            <h2>Toplam Puan: <span id="final-score">0</span></h2>
            <p id="feedback-text"></p>
            <button class="btn" onclick="goHome()">Ana Men√ºye D√∂n</button>
        </div>

        <!-- ƒ∞PUCU POPUP -->
        <div id="hint-modal" class="modal-overlay" onclick="closeHint()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h3>üí° ƒ∞pucu</h3>
                <p id="hint-text" style="color:#555;"></p>
                <!-- HATA Y√ñNETƒ∞Mƒ∞ EKLENDƒ∞ -->
                <img id="hint-image" src="" alt="G√∂rsel Yok" onerror="handleImageError(this)">
                <div id="img-error-msg" style="color:#EF4444; font-size:0.8rem; margin-top:5px; display:none;"></div>
                <button class="btn" style="padding: 10px 20px; font-size: 0.9rem; margin-top:10px;" onclick="closeHint()">Kapat</button>
            </div>
        </div>

        <!-- S√úRE SE√áƒ∞M MODALI -->
        <div id="timer-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>‚è±Ô∏è S√ºre Se√ßimi</h3>
                <p>Sorularda geriye sayƒ±m olsun mu?</p>
                <button class="btn" onclick="confirmStart(true)">Evet, Olsun</button>
                <button class="btn" style="background-color:#6B7280; margin-top:10px" onclick="confirmStart(false)">Hayƒ±r, Olmasƒ±n</button>
            </div>
        </div>

        <!-- Bƒ∞Tƒ∞RME UYARI MODALI -->
        <div id="finish-warning-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>‚ö†Ô∏è Bo≈ü Sorular Var!</h3>
                <p>Hen√ºz √ß√∂zmediƒüiniz sorular bulunuyor.</p>
                <button class="btn" style="background-color:#EF4444;" onclick="finishExamForce()">Sƒ±navƒ± Bitir</button>
                <button class="btn" style="background-color:var(--primary); margin-top:10px" onclick="goToFirstEmpty()">Bo≈ü Soruya D√∂n</button>
            </div>
        </div>

    </div>

    <script>
        // --- AYARLAR ---
        const SHEET_ID = "2PACX-1vRpQT51KZk-RD0zVwuobsm-5Cyofh5x-Z6AAUBQQ_GOH7rOc4KgKuFtkBw7lntpIaaRClcY5Hngf27R";
        const timeStamp = new Date().getTime(); 
        const SHEET_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?output=csv&gid=0&v=${timeStamp}`;

        const PROXIES = [
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(SHEET_CSV_URL)}`,
            `https://corsproxy.io/?${encodeURIComponent(SHEET_CSV_URL)}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(SHEET_CSV_URL)}`
        ];

        // --- DEƒûƒ∞≈ûKENLER ---
        let allQuestions = [];
        let currentQuestions = [];
        let userAnswers = []; 
        let currentIndex = 0;
        let score = 0;
        let timer;
        let timeLeft;
        let isTimerRunning = false;
        
        let selectedLesson = null;
        let isTimerEnabled = true;
        
        let isReviewMode = false;
        let wrongQuestionIndices = []; 
        let reviewStep = 0; 

        // --- BA≈ûLANGI√á ---
        window.onload = function() { tryFetchData(0); };

        function tryFetchData(proxyIndex) {
            const statusText = document.getElementById('status-text');
            const errorLog = document.getElementById('error-log');

            if (proxyIndex >= PROXIES.length) {
                statusText.innerText = "Baƒülantƒ± kurulamadƒ±.";
                statusText.style.color = "red";
                document.getElementById('retry-btn').style.display = 'inline-block';
                document.getElementById('demo-btn').style.display = 'inline-block';
                return;
            }

            statusText.innerText = `Veriler g√ºncelleniyor (Y√∂ntem ${proxyIndex + 1})...`;
            
            fetch(PROXIES[proxyIndex])
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(csvText => {
                    const questions = parseCSV(csvText);
                    if (questions.length > 0) {
                        allQuestions = questions;
                        initApp();
                    } else {
                        throw new Error("Veri bo≈ü veya format hatalƒ±.");
                    }
                })
                .catch(err => {
                    console.warn(`Proxy ${proxyIndex} hatasƒ±:`, err);
                    errorLog.style.display = 'block';
                    errorLog.innerHTML += `<div>Y√∂ntem ${proxyIndex + 1} Ba≈üarƒ±sƒ±z: ${err.message}</div>`;
                    tryFetchData(proxyIndex + 1);
                });
        }

        // --- CSV AYRI≈ûTIRICI ---
        function parseCSV(text) {
            if (!text || text.length < 10) return [];
            const rawLines = text.trim().split(/\r\n|\n|\r/);
            const lines = [];
            let buffer = "";
            for (let i = 0; i < rawLines.length; i++) {
                let line = rawLines[i];
                if (buffer) buffer += "\n" + line; else buffer = line;
                const quoteCount = (buffer.match(/"/g) || []).length;
                if (quoteCount % 2 === 0) { lines.push(buffer); buffer = ""; }
            }
            const result = [];
            let lastValidLessonSlug = "genel"; 
            let lastValidLessonDisplay = "Genel";

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i];
                if (!row || row.length < 5) continue; 
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const clean = cols.map(c => {
                    if (!c) return "";
                    let val = c.trim();
                    if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1).replace(/""/g, '"');
                    return val;
                });
                if (clean.length < 3 || !clean[2]) continue;

                let rawLesson = clean[1] || "";
                let lessonSlug = "";
                let displayLesson = "";
                if (!isNaN(rawLesson) && rawLesson.trim().length < 5) {
                    lessonSlug = lastValidLessonSlug;
                    displayLesson = lastValidLessonDisplay;
                } else {
                    let cleanLessonName = rawLesson.replace(/[\u200B-\u200D\uFEFF]/g, '').trim();
                    lessonSlug = cleanLessonName.toLocaleLowerCase('tr-TR')
                                          .replace(/ƒ±/g, 'i').replace(/≈ü/g, 's').replace(/ƒü/g, 'g')
                                          .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                                          .replace(/[^a-z0-9]/g, ''); 
                    displayLesson = rawLesson;
                    if (lessonSlug.length > 2) {
                        lastValidLessonSlug = lessonSlug;
                        lastValidLessonDisplay = rawLesson;
                    }
                }
                
                // --- ƒ∞PUCU VE RESƒ∞M AYRI≈ûTIRMA ---
                let rawHint = clean[9] ? clean[9].trim() : "";
                let imgId = clean[10] ? clean[10].trim() : "";
                
                // J kolonunda sayƒ± varsa onu resim ID olarak kullan
                if (!imgId && rawHint.length > 0 && rawHint.length < 5 && !isNaN(rawHint)) {
                    imgId = rawHint;
                    rawHint = ""; 
                }
                
                if (!imgId) imgId = clean[0];

                let finalHintText = rawHint; 
                let imgPath = `images/Soru_${lessonSlug}_${imgId}.png`;

                result.push({
                    id: clean[0], lesson: lessonSlug, lessonDisplay: displayLesson, text: clean[2],
                    options: [clean[3] || "A", clean[4] || "B", clean[5] || "C", clean[6] || "D"],
                    correct: parseInt(clean[7]) || 0,
                    time: parseInt(clean[8]) || 60,
                    hintText: finalHintText,
                    hintImage: imgPath,
                    points: 10
                });
            }
            return result;
        }

        // --- UYGULAMA BA≈ûLATMA ---
        function initApp() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('home-screen').classList.add('active');
            document.getElementById('total-q-count').innerText = allQuestions.length;

            const subjects = [...new Set(allQuestions.map(q => q.lesson))];
            const btnContainer = document.getElementById('subject-buttons');
            btnContainer.innerHTML = '';

            const names = {
                'matematik': 'üìê Matematik', 'turkce': 'üìö T√ºrk√ße', 'fen': 'üß¨ Fen Bilimleri',
                'fenbilimleri': 'üß¨ Fen Bilimleri', 'inkilap': 'üáπüá∑ ƒ∞nkƒ±lap Tarihi',
                'inkilaptarihi': 'üáπüá∑ ƒ∞nkƒ±lap Tarihi', 'ingilizce': 'üá¨üáß ƒ∞ngilizce', 'din': 'üïå Din K√ºlt√ºr√º'
            };

            subjects.forEach(subj => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-subject';
                if (subj.includes("hata")) {
                    btn.style.backgroundColor = "#fee2e2"; btn.style.color = "#dc2626"; btn.style.borderColor = "#dc2626";
                    const originalQ = allQuestions.find(q => q.lesson === subj);
                    btn.innerText = originalQ ? originalQ.lessonDisplay : subj;
                } else {
                    btn.innerText = names[subj] || subj.toUpperCase();
                }
                btn.onclick = () => preStartQuiz(subj);
                btnContainer.appendChild(btn);
            });
        }

        function preStartQuiz(lesson) {
            selectedLesson = lesson;
            document.getElementById('timer-modal').style.display = 'flex';
        }

        function confirmStart(enableTimer) {
            isTimerEnabled = enableTimer;
            document.getElementById('timer-modal').style.display = 'none';
            startQuiz(selectedLesson);
        }

        function startQuiz(lesson) {
            isReviewMode = false;
            currentQuestions = allQuestions.filter(q => q.lesson === lesson);
            
            if (currentQuestions.length === 0) {
                alert("Bu ders i√ßin soru bulunamadƒ±.");
                return;
            }

            userAnswers = new Array(currentQuestions.length).fill(null);
            currentIndex = 0; score = 0;
            
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            document.getElementById('result-screen').classList.remove('active');
            
            document.getElementById('review-banner').style.display = 'none';
            document.getElementById('score-display').parentElement.style.visibility = 'hidden';
            
            loadQuestion();
        }

        function loadQuestion() {
            let qIndex = currentIndex;
            if (isReviewMode) {
                qIndex = wrongQuestionIndices[reviewStep];
            }

            const q = currentQuestions[qIndex];
            const selectedAnswer = userAnswers[qIndex]; 

            if (isReviewMode) {
                 document.getElementById('question-text').innerText = `[Yanlƒ±≈ü Soru ${reviewStep + 1}/${wrongQuestionIndices.length}] ${q.text}`;
            } else {
                 document.getElementById('question-text').innerText = `${qIndex + 1}) ${q.text}`;
            }
            
            if (isTimerEnabled && !isReviewMode) {
                timeLeft = q.time; 
                startTimer();
                document.getElementById('time-display').innerText = timeLeft;
                document.getElementById('time-display').style.visibility = 'visible';
            } else {
                clearInterval(timer);
                document.getElementById('time-display').style.visibility = 'hidden';
            }
            
            const total = isReviewMode ? wrongQuestionIndices.length : currentQuestions.length;
            const current = isReviewMode ? reviewStep : qIndex;
            const percent = (current / total) * 100;
            document.getElementById('progress-fill').style.width = `${percent}%`;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                btn.innerText = opt;
                
                if (isReviewMode) {
                    btn.disabled = true;
                    if (idx === q.correct) btn.classList.add('correct-review');
                    if (selectedAnswer === idx && idx !== q.correct) btn.classList.add('wrong-review');
                } else {
                    if (selectedAnswer === idx) btn.classList.add('selected');
                    btn.onclick = () => selectAnswer(qIndex, idx);
                }
                
                container.appendChild(btn);
            });

            // ƒ∞PUCU AYARLARI
            const hintTextEl = document.getElementById('hint-text');
            const hintImgEl = document.getElementById('hint-image');
            const errorMsgEl = document.getElementById('img-error-msg');
            
            hintTextEl.innerText = q.hintText;
            hintTextEl.style.display = q.hintText ? "block" : "none";
            
            // G√∂rseli resetle
            hintImgEl.style.display = "block";
            hintImgEl.removeAttribute('data-tried-root'); // Hata durumunu sƒ±fƒ±rla
            errorMsgEl.style.display = 'none';
            hintImgEl.src = q.hintImage;

            const isFirst = isReviewMode ? (reviewStep === 0) : (qIndex === 0);
            const isLast = isReviewMode ? (reviewStep === wrongQuestionIndices.length - 1) : (qIndex === currentQuestions.length - 1);
            
            document.getElementById('prev-btn').disabled = isFirst;
            let nextText = "Sonraki ‚û°Ô∏è";
            if (isLast) nextText = isReviewMode ? "ƒ∞ncelemeyi Bitir" : "Sƒ±navƒ± Bitir üèÅ";
            document.getElementById('next-btn').innerText = nextText;
        }

        // --- G√ñRSEL HATA Y√ñNETƒ∞Mƒ∞ ---
        function handleImageError(img) {
            // Eƒüer zaten k√∂k dizini denediysek ve olmadƒ±ysa pes et
            if (img.dataset.triedRoot === "true") {
                img.style.display = 'none';
                const errorMsgEl = document.getElementById('img-error-msg');
                const fileName = img.src.split('/').pop();
                errorMsgEl.innerHTML = `‚ö†Ô∏è <b>G√∂rsel Bulunamadƒ±</b><br>Aranan Dosya: <span style="font-family:monospace; color:black;">${fileName}</span><br>L√ºtfen dosya adƒ±nƒ±n tam olarak bu olduƒüundan emin olun.`;
                errorMsgEl.style.display = 'block';
                return;
            }
            
            // images/ klas√∂r√ºnde bulamadƒ±, bir de klas√∂rs√ºz (yanƒ±na) bak
            let currentSrc = img.getAttribute('src');
            if (currentSrc && currentSrc.includes('images/')) {
                img.dataset.triedRoot = "true";
                img.src = currentSrc.replace('images/', '');
                console.log("Klas√∂rde bulunamadƒ±, ana dizinde aranƒ±yor: " + img.src);
            } else {
                // Zaten images/ yoksa demek ki hi√ß bulunamadƒ±
                img.dataset.triedRoot = "true"; // D√∂ng√ºy√º kƒ±r
                handleImageError(img);
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            isTimerRunning = true;
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('time-display').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    isTimerRunning = false;
                }
            }, 1000);
        }

        function selectAnswer(qIndex, idx) {
            userAnswers[qIndex] = idx;
            const buttons = document.querySelectorAll('.btn-option');
            buttons.forEach((b, i) => {
                b.classList.remove('selected');
                if (i === idx) b.classList.add('selected');
            });
        }

        function prevQuestion() {
            if (isReviewMode) {
                if (reviewStep > 0) { reviewStep--; loadQuestion(); }
            } else {
                if (currentIndex > 0) { currentIndex--; loadQuestion(); }
            }
        }

        function nextQuestion() {
            if (isReviewMode) {
                if (reviewStep < wrongQuestionIndices.length - 1) { reviewStep++; loadQuestion(); }
                else {
                    document.getElementById('quiz-screen').classList.remove('active');
                    document.getElementById('result-screen').classList.add('active');
                }
            } else {
                if (currentIndex < currentQuestions.length - 1) { currentIndex++; loadQuestion(); }
                else checkFinish();
            }
        }

        function checkFinish() {
            const hasEmpty = userAnswers.includes(null) || userAnswers.includes(undefined);
            if (hasEmpty) document.getElementById('finish-warning-modal').style.display = 'flex';
            else endQuiz();
        }

        function goToFirstEmpty() {
            document.getElementById('finish-warning-modal').style.display = 'none';
            const firstEmptyIndex = userAnswers.findIndex(ans => ans === null || ans === undefined);
            if (firstEmptyIndex !== -1) { currentIndex = firstEmptyIndex; loadQuestion(); }
        }

        function finishExamForce() {
            document.getElementById('finish-warning-modal').style.display = 'none';
            endQuiz();
        }

        function endQuiz() {
            clearInterval(timer);
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            
            let correctCount = 0; let wrongCount = 0; let emptyCount = 0;
            score = 0; wrongQuestionIndices = [];

            userAnswers.forEach((ans, index) => {
                const q = currentQuestions[index];
                if (ans === null || ans === undefined) emptyCount++;
                else if (ans === q.correct) { correctCount++; score += q.points; }
                else { wrongCount++; wrongQuestionIndices.push(index); }
            });

            document.getElementById('res-correct').innerText = correctCount;
            document.getElementById('res-wrong').innerText = wrongCount;
            document.getElementById('res-empty').innerText = emptyCount;
            document.getElementById('final-score').innerText = score;

            const wrongBox = document.getElementById('wrong-box');
            if (wrongCount > 0) {
                wrongBox.classList.add('clickable');
                wrongBox.title = "Yanlƒ±≈ülarƒ±nƒ± incelemek i√ßin tƒ±kla";
                wrongBox.onclick = startReview;
                wrongBox.style.opacity = "1";
            } else {
                wrongBox.classList.remove('clickable');
                wrongBox.title = "Yanlƒ±≈ü yok";
                wrongBox.onclick = null;
                wrongBox.style.opacity = "0.7";
            }
            
            const msg = document.getElementById('feedback-text');
            if (score > (currentQuestions.length * 8)) msg.innerText = "Harika ƒ∞≈ü! üéâ";
            else msg.innerText = "Sƒ±nav Bitti. Sonu√ßlarƒ±nƒ± kontrol et.";
        }

        function startReview() {
            if (wrongQuestionIndices.length === 0) return;
            isReviewMode = true; reviewStep = 0;
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            document.getElementById('review-banner').style.display = 'block';
            loadQuestion();
        }

        function confirmHome() {
            if(confirm("Sƒ±navƒ± sonlandƒ±rƒ±p ana men√ºye d√∂nmek istiyor musunuz?")) goHome();
        }

        function goHome() {
            clearInterval(timer); isReviewMode = false;
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('home-screen').classList.add('active');
        }
        
        function showHint() { document.getElementById('hint-modal').style.display = 'flex'; }
        function closeHint() { document.getElementById('hint-modal').style.display = 'none'; }

        function useDemoData() {
            allQuestions = [
                { lesson: 'matematik', text: 'DEMO: 12 x 12 = ?', options: ['124','144','156','160'], correct: 1, time: 30, hintText: 'Sonu 4 ile bitmeli', hintImage: '', points: 10 },
                { lesson: 'turkce', text: 'DEMO: Zƒ±t anlamlƒ± kelime √ßifti hangisidir?', options: ['Ak-Beyaz','Siyah-Kara','ƒ∞leri-Geri','Okul-Mektep'], correct: 2, time: 30, hintText: 'Birbirinin tersi olmalƒ±', hintImage: '', points: 10 }
            ];
            initApp();
        }
    </script>
</body>
</html>