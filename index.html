<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LGS Hazƒ±rlƒ±k Portalƒ±</title>
    <style>
        /* --- TASARIM --- */
        :root {
            --primary: #4F46E5; --secondary: #10B981; --danger: #EF4444; 
            --warning: #F59E0B; --bg: #F8FAFC; --text: #1F2937; --empty: #9CA3AF;
            --selected: #3B82F6; --special: #7C3AED;
            --header-bg: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- YENƒ∞: WEB Sƒ∞TESƒ∞ √úST MEN√ú (HEADER) --- */
        .site-header {
            background-color: var(--header-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky; top: 0; z-index: 100;
            width: 100%;
        }
        .header-content {
            max-width: 1200px; margin: 0 auto; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand {
            font-size: 1.5rem; font-weight: 800; color: var(--primary);
            display: flex; align-items: center; gap: 10px; text-decoration: none;
        }
        .brand span { color: var(--text); font-weight: 400; font-size: 1.2rem; }
        .user-info { font-size: 0.9rem; color: #666; display: none; } 

        /* --- ANA ƒ∞√áERƒ∞K ALANI --- */
        .main-wrapper {
            flex: 1; 
            display: flex; justify-content: center; align-items: flex-start;
            padding: 40px 20px;
        }

        .app-container {
            background: white; width: 100%; max-width: 700px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #E5E7EB;
            overflow: hidden; position: relative; min-height: 700px;
            display: flex; flex-direction: column; transition: max-width 0.3s ease;
        }

        /* --- YENƒ∞: ALT Bƒ∞LGƒ∞ (FOOTER) --- */
        .site-footer {
            background-color: white; border-top: 1px solid #E5E7EB;
            padding: 20px; text-align: center; color: #6B7280; font-size: 0.9rem;
        }

        /* Y√úKLENƒ∞YOR EKRANI */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-text { 
            font-size: 1.1rem; color: #4b5563; margin-bottom: 10px; font-weight: 500;
            animation: pulse 1.5s infinite ease-in-out; 
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .error-log { display: none; }

        /* EKRANLAR */
        .screen { display: none; padding: 40px; flex: 1; flex-direction: column; align-items: center; justify-content: center; text-align: center; animation: fadeIn 0.4s ease; position: relative; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { color: var(--primary); margin-bottom: 20px; }
        
        .btn {
            background-color: var(--primary); color: white; border: none;
            padding: 15px 30px; border-radius: 12px; font-size: 1.1rem;
            cursor: pointer; width: 100%; margin: 8px 0; font-weight: bold;
            transition: 0.2s; font-family: inherit;
        }
        .btn:active { transform: scale(0.98); }
        .btn-subject { 
            background-color: white; color: var(--text); border: 2px solid #E5E7EB; 
            transition: all 0.2s ease;
        }
        .btn-subject:hover { 
            border-color: var(--primary); color: var(--primary); background: #F8FAFC; 
            transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* GENEL SINAV BUTONU */
        .btn-general-exam {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white; border: none; padding: 25px; margin-bottom: 30px;
            font-size: 1.3rem; box-shadow: 0 10px 20px rgba(124, 58, 237, 0.2);
            border-radius: 16px; letter-spacing: 0.5px;
        }
        .btn-general-exam:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(124, 58, 237, 0.3); }

        /* KONUYA G√ñRE SINAV BUTONU (YENƒ∞) */
        .btn-topic-exam {
            background: white; border: 2px solid var(--primary); color: var(--primary);
            padding: 15px; margin-bottom: 20px; font-size: 1.1rem;
            border-radius: 12px;
        }
        .btn-topic-exam:hover { background-color: #EEF2FF; }

        /* Sƒ±navƒ± Bitir Butonu */
        .btn-finish-exam {
            background-color: #fee2e2; color: #DC2626; border: 1px solid #FECACA;
            margin-top: 30px; padding: 12px; width: 100%;
        }
        .btn-finish-exam:hover { background-color: #FECACA; }

        /* ≈ûIK BUTONLARI */
        .btn-option {
            background-color: #F9FAFB; color: var(--text); border: 2px solid #E5E7EB;
            text-align: left; position: relative; transition: all 0.2s;
            display: flex; flex-direction: column;
            align-items: flex-start; justify-content: center;
            min-height: 50px; width: 100%; margin-bottom: 12px; padding: 15px 20px;
            border-radius: 12px; font-family: inherit; font-size: 1.05rem;
        }
        .btn-option:hover { background-color: #F3F4F6; border-color: #9CA3AF; }
        .btn-option.selected { 
            background-color: #EFF6FF; border-color: var(--selected); color: var(--selected); 
            box-shadow: 0 0 0 2px var(--selected) inset; font-weight: bold;
        }
        .btn-option.correct-review { background-color: #ECFDF5; border-color: var(--secondary); color: var(--secondary); box-shadow: 0 0 0 1px var(--secondary) inset; }
        .btn-option.wrong-review { background-color: #FEF2F2; border-color: var(--danger); color: var(--danger); box-shadow: 0 0 0 1px var(--danger) inset; }
        .btn-option:disabled { cursor: default; opacity: 0.8; }
        
        .btn-option img {
            max-width: 100%; max-height: 200px; border-radius: 8px;
            margin-bottom: 10px; align-self: center; display: none; 
            object-fit: contain; border: 1px solid #eee;
        }

        /* YARDIMCI BUTONLAR GRUBU (ƒ∞PUCU & CEVABI G√ñR) */
        .helper-buttons {
            display: flex; gap: 15px; margin-top: 20px; align-self: flex-start;
        }

        .hint-btn {
            background: none; border: none; color: var(--warning); cursor: pointer;
            font-size: 1rem; text-decoration: none;
            display: flex; align-items: center; gap: 8px; font-weight: bold;
            padding: 8px 12px; border-radius: 8px; transition: background 0.2s;
        }
        .hint-btn:hover { background-color: #FFFBEB; }
        
        .show-answer-btn {
            background: none; border: none; color: var(--secondary); cursor: pointer;
            font-size: 1rem; text-decoration: none;
            display: flex; align-items: center; gap: 8px; font-weight: bold;
            padding: 8px 12px; border-radius: 8px; transition: background 0.2s;
        }
        .show-answer-btn:hover { background-color: #ECFDF5; }

        /* NAVƒ∞GASYON BUTONLARI */
        .nav-buttons {
            display: flex; justify-content: space-between; width: 100%; margin-top: 30px; gap: 15px;
        }
        .btn-nav {
            background-color: #F3F4F6; color: #374151; flex: 1; padding: 15px;
            font-size: 1.1rem; border-radius: 12px; border: 1px solid #E5E7EB; cursor: pointer;
            font-weight: bold; font-family: inherit; transition: all 0.2s;
        }
        .btn-nav:hover { background-color: #E5E7EB; border-color: #D1D5DB; }
        .btn-nav.primary { background-color: var(--primary); color: white; border: none; }
        .btn-nav.primary:hover { background-color: #4338ca; }
        .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }

        /* √úST √áUBUK */
        .top-bar { display: flex; justify-content: space-between; width: 100%; margin-bottom: 25px; font-weight: bold; font-size: 1.2rem; align-items: center; border-bottom: 2px solid #F3F4F6; padding-bottom: 15px; }
        .timer-box { color: var(--danger); font-variant-numeric: tabular-nums; display: flex; align-items: center; gap: 5px; } 
        .score-box { color: var(--primary); }
        
        .home-btn-corner {
            position: absolute; top: 20px; right: 20px;
            background: #F3F4F6; color: #666; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; font-size: 1.3rem; display: flex; align-items: center; justify-content: center;
            z-index: 10; transition: background 0.2s;
        }
        .home-btn-corner:hover { background: #E5E7EB; color: #333; }

        .back-to-results-btn {
            position: absolute; top: 20px; left: 20px;
            background: white; color: var(--primary); border: 2px solid var(--primary);
            padding: 8px 16px; border-radius: 8px;
            cursor: pointer; font-size: 0.9rem; font-weight: bold;
            display: none; z-index: 10; transition: all 0.2s;
        }
        .back-to-results-btn:hover { background: var(--primary); color: white; }

        /* SONU√á ƒ∞STATƒ∞STƒ∞KLERƒ∞ VE Lƒ∞STESƒ∞ */
        .stats-container {
            display: flex; gap: 15px; width: 100%; justify-content: center; margin: 30px 0;
        }
        .stat-box {
            flex: 1; padding: 20px 10px; border-radius: 16px; text-align: center;
            color: white; font-weight: bold; display: flex; flex-direction: column; gap: 5px;
            cursor: default; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-box.correct { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .stat-box.wrong { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        .stat-box.empty { background: linear-gradient(135deg, #9CA3AF 0%, #6B7280 100%); }
        .stat-box span { font-size: 2rem; }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px; width: 100%; margin-top: 20px; margin-bottom: 20px;
            max-height: 300px; overflow-y: auto; padding: 5px;
        }
        .q-result-item {
            width: 100%; aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; font-weight: bold; color: white;
            cursor: pointer; transition: transform 0.2s; font-size: 1.2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .q-result-item:hover { transform: scale(1.1); }
        .q-result-item.correct { background-color: var(--secondary); }
        .q-result-item.wrong { background-color: var(--danger); }
        .q-result-item.empty { background-color: var(--empty); }

        /* KONU SE√áƒ∞M EKRANI STƒ∞LLERƒ∞ */
        .topic-list-container {
            width: 100%; max-height: 450px; overflow-y: auto; text-align: left;
            margin: 20px 0; border: 1px solid #E5E7EB; border-radius: 12px; padding: 15px;
            background: #F9FAFB;
        }
        .topic-group { margin-bottom: 20px; }
        .topic-group h3 { 
            font-size: 1.1rem; color: var(--primary); border-bottom: 2px solid #E5E7EB; 
            padding-bottom: 5px; margin-bottom: 10px; font-weight: 700;
        }
        .topic-item { 
            display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 5px 0;
        }
        .topic-item:hover { background-color: #EEF2FF; border-radius: 5px; }
        .topic-item input { 
            margin-right: 12px; transform: scale(1.2); accent-color: var(--primary); cursor: pointer;
        }
        .topic-item label { cursor: pointer; width: 100%; }

        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 100;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .modal-content img { max-width: 100%; border-radius: 10px; margin: 15px 0; border: 1px solid #ddd; }

        .question-text { 
            font-size: 1.35rem; font-weight: 600; margin-bottom: 25px; width: 100%; 
            text-align: left; line-height: 1.6; color: #111827;
        }
        /* HTML Etiketleri i√ßin Stil Desteƒüi */
        .question-text b, .question-text strong { font-weight: 800; color: #000; }
        .question-text u { text-decoration: underline; text-decoration-thickness: 3px; text-decoration-color: #d1d5db; }
        .question-text sub { font-size: 0.75em; vertical-align: sub; }
        .question-text sup { font-size: 0.75em; vertical-align: super; }
        
        /* SORU KAYNAƒûI Bƒ∞LGƒ∞Sƒ∞ */
        .question-source {
            font-size: 0.85rem; color: #9CA3AF; font-style: italic; text-align: right;
            margin-top: 10px; margin-bottom: 20px; width: 100%;
        }

        .question-inner-img {
            max-width: 100%; max-height: 400px; border-radius: 12px;
            margin: 15px auto; display: none; border: 1px solid #E5E7EB;
            object-fit: contain; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .progress-bar { width: 100%; height: 6px; background: #F3F4F6; border-radius: 3px; margin-bottom: 25px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 3px; transition: width 0.5s ease-out; }
        
        .review-banner {
            background-color: #FEF3C7; color: #D97706; padding: 12px; width: 100%;
            text-align: center; font-weight: bold; font-size: 0.95rem; margin-bottom: 20px;
            border-radius: 8px; display: none; border: 1px solid #FCD34D;
        }

        /* --- MASA√úST√ú / GENƒ∞≈û EKRAN (16:9 MODU) --- */
        @media (min-width: 1024px) {
            .app-container { 
                max-width: 1200px; 
                min-height: 700px;
                padding: 0; /* ƒ∞√ßerik padding'i grid i√ßinde */
            }

            /* EKRANLARIN ƒ∞√á D√úZENƒ∞ */
            .screen { padding: 40px 60px; }

            #quiz-screen.active {
                display: grid;
                grid-template-columns: 1.2fr 0.8fr; /* Soru alanƒ± daha geni≈ü */
                grid-template-rows: auto auto auto 1fr auto auto;
                column-gap: 50px; row-gap: 0;
                align-items: start; text-align: left; padding: 40px 60px;
                height: 100%;
            }

            /* Izgara Yerle≈üimi */
            .home-btn-corner { top: 30px; right: 40px; }
            .back-to-results-btn { top: 30px; left: 40px; } 
            
            .review-banner { grid-column: 1 / -1; margin-bottom: 20px; }
            .top-bar { grid-column: 1 / -1; margin-bottom: 10px; }
            .progress-bar { grid-column: 1 / -1; margin-bottom: 30px; }

            /* Sol S√ºtun: Soru ve G√∂rsel */
            #question-text { 
                grid-column: 1 / 2; 
                grid-row: 4 / 6;
                font-size: 1.5rem; 
                padding-right: 20px;
                border-right: 1px solid #E5E7EB; /* Ayƒ±rƒ±cƒ± √ßizgi */
            }
            .question-source {
                grid-column: 1 / 2;
                grid-row: 6 / 7;
                padding-right: 20px;
                border-right: 1px solid #E5E7EB;
            }
            #question-inner-img {
                grid-column: 1 / 2;
                grid-row: 7 / 8; 
                align-self: start;
                max-height: 500px;
                margin-top: 20px;
            }

            /* Saƒü S√ºtun: ≈ûƒ±klar ve Kontroller */
            #options-container {
                grid-column: 2 / 3;
                grid-row: 4 / 5; 
                align-self: start;
                padding-left: 20px;
            }

            .helper-buttons {
                grid-column: 2 / 3;
                grid-row: 5 / 6;
                margin-left: 20px;
                flex-wrap: wrap; /* Sƒ±ƒümazsa alt satƒ±ra ge√ßsin */
            }

            .nav-buttons {
                grid-column: 2 / 3;
                grid-row: 6 / 7;
                margin-top: 30px;
                padding-left: 20px;
            }

            .btn-finish-exam {
                grid-column: 2 / 3;
                grid-row: 7 / 8;
                margin-left: 20px;
            }

            /* Ana Men√º */
            #subject-buttons { 
                display: grid; 
                grid-template-columns: repeat(2, 1fr); 
                gap: 20px; 
                width: 100%; 
            }
            .btn-general-exam { grid-column: 1 / -1; }
            .btn-topic-exam { grid-column: 1 / -1; }
            
            .user-info { display: block; }
        }
    </style>
</head>
<body>

    <!-- YENƒ∞ HEADER -->
    <header class="site-header">
        <div class="header-content">
            <a href="#" onclick="location.reload()" class="brand">
                üöÄ <span>LGS Hazƒ±rlƒ±k Portalƒ±</span>
            </a>
            <div class="user-info">Ba≈üarƒ±lar Dileriz!</div>
        </div>
    </header>

    <!-- ANA ƒ∞√áERƒ∞K -->
    <div class="main-wrapper">
        <div class="app-container">

            <!-- Y√úKLEME EKRANI -->
            <div id="loading-screen">
                <div class="spinner"></div>
                <h2 style="color: var(--primary);">L√ºtfen Bekleyin</h2>
                <p id="status-text" class="status-text">Sorular Y√ºkleniyor...</p>
                <div id="error-log" class="error-log"></div>
                <button id="retry-btn" class="btn" style="display:none; background:#4b5563; font-size:0.9rem;" onclick="location.reload()">üîÑ Tekrar Dene</button>
                <button id="demo-btn" class="btn" style="display:none; background:#f59e0b; font-size:0.9rem;" onclick="useDemoData()">‚ö†Ô∏è Demo Modu ile A√ß</button>
            </div>

            <!-- ANA MEN√ú -->
            <div id="home-screen" class="screen">
                <h1 style="font-size: 2.2rem; margin-bottom: 10px;">Ho≈ü Geldiniz üéì</h1>
                <p style="color: #666; margin-bottom: 20px;">Bug√ºn hangi dersten soru √ß√∂zmek istersiniz?</p>
                
                <button class="btn btn-general-exam" onclick="startGeneralExam()">
                    üöÄ GENEL DENEME BA≈ûLAT <span style="font-size:0.9em; opacity:0.9; font-weight:normal;">(155 Dk)</span>
                </button>

                <button class="btn btn-topic-exam" onclick="openTopicSelection()">
                    üéØ Konuya G√∂re Soru √á√∂z
                </button>
                
                <div style="width:100%; height:1px; background:#e5e7eb; margin:10px 0 25px 0;"></div>
                
                <div id="subject-buttons"></div>
                
                <div style="margin-top:30px; font-size:0.85rem; color:#999; border-top:1px solid #f3f4f6; padding-top:15px; width:100%;">
                    Sistemde toplam <strong style="color:var(--text);"><span id="total-q-count">0</span></strong> soru bulunmaktadƒ±r.
                </div>
            </div>

            <!-- KONU SE√áƒ∞M EKRANI (YENƒ∞) -->
            <div id="topic-selection-screen" class="screen">
                <h2 style="color:var(--primary);">Konu Se√ßimi</h2>
                <p style="color:#666; margin-bottom:20px;">L√ºtfen √ßalƒ±≈ümak istediƒüiniz konularƒ± i≈üaretleyin.</p>
                
                <div id="topic-list-container" class="topic-list-container">
                    <!-- Konular buraya JS ile gelecek -->
                </div>

                <div class="nav-buttons" style="margin-top:10px;">
                    <button class="btn-nav" onclick="goHome()">ƒ∞ptal</button>
                    <button class="btn-nav primary" onclick="prepareTopicQuiz()">Se√ßilenleri √á√∂z</button>
                </div>
            </div>

            <!-- SINAV EKRANI -->
            <div id="quiz-screen" class="screen">
                <button class="home-btn-corner" onclick="openHomeModal()" title="Ana Men√º">üè†</button>
                <button id="back-to-results-btn" class="back-to-results-btn" onclick="returnToResults()">üîô Sonu√ßlara D√∂n</button>
                
                <div id="review-banner" class="review-banner">üìù Yanlƒ±≈ü Cevap ƒ∞nceleme Modu</div>
                
                <div class="top-bar">
                    <div class="timer-box">‚è±Ô∏è <span id="time-display">00:00</span></div>
                    <div class="score-box" style="visibility: hidden;">Puan: <span id="score-display">0</span></div>
                </div>
                
                <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                
                <!-- SORU METNƒ∞ VE G√ñRSELƒ∞ -->
                <div class="question-text" id="question-text"></div>
                
                <!-- YENƒ∞: SORU KAYNAK Bƒ∞LGƒ∞Sƒ∞ -->
                <div id="question-source" class="question-source"></div>

                <img id="question-inner-img" class="question-inner-img" src="" alt="Soru G√∂rseli" onerror="this.style.display='none'">
                
                <!-- ≈ûIKLAR -->
                <div id="options-container" style="width: 100%;"></div>

                <div class="helper-buttons">
                    <button class="hint-btn" onclick="showHint()">üí° ƒ∞pucu G√∂ster</button>
                    <!-- CEVABI G√ñR BUTONU -->
                    <button class="show-answer-btn" onclick="openAnswerModal()">üëÅÔ∏è Cevabƒ± G√∂r</button>
                </div>

                <!-- NAVƒ∞GASYON -->
                <div class="nav-buttons">
                    <button class="btn-nav" id="prev-btn" onclick="prevQuestion()">‚¨ÖÔ∏è √ñnceki</button>
                    <button class="btn-nav primary" id="next-btn" onclick="nextQuestion()">Sonraki ‚û°Ô∏è</button>
                </div>

                <!-- SINAVI Bƒ∞Tƒ∞R BUTONU -->
                <button id="btn-finish-exam" class="btn btn-finish-exam" onclick="checkFinish()">üèÅ Sƒ±navƒ± Bitir</button>
            </div>

            <!-- SONU√á EKRANI -->
            <div id="result-screen" class="screen">
                <h1>üèÅ Sƒ±nav Tamamlandƒ±!</h1>
                
                <div class="stats-container">
                    <div class="stat-box correct"><span>‚úÖ</span> <span id="res-correct" style="font-size:1.8rem">0</span> Doƒüru</div>
                    <div class="stat-box wrong" id="wrong-box" onclick="startReview()" title="Yanlƒ±≈ülarƒ±nƒ± incelemek i√ßin tƒ±kla" style="cursor: pointer;">
                        <span>‚ùå</span> <span id="res-wrong" style="font-size:1.8rem">0</span> Yanlƒ±≈ü
                        <div style="font-size:0.7rem; font-weight:normal; opacity:0.9;">(ƒ∞ncele)</div>
                    </div>
                    <div class="stat-box empty"><span>‚ö™</span> <span id="res-empty" style="font-size:1.8rem">0</span> Bo≈ü</div>
                </div>
                
                <div style="width:100%; text-align:left; margin-top:20px; font-weight:600; color:#374151;">Soru Listesi (Detay i√ßin tƒ±kla):</div>
                <div id="result-list-container" class="result-grid"></div>

                <h2 style="margin-top:30px;">Toplam Puan: <span id="final-score" style="color:var(--primary);">0</span></h2>
                <p id="feedback-text" style="color:#666;"></p>
                
                <button class="btn" onclick="goHome()" style="margin-top:20px;">Ana Men√ºye D√∂n</button>
            </div>

            <!-- ƒ∞PUCU POPUP -->
            <div id="hint-modal" class="modal-overlay" onclick="closeHint()">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <h3 style="margin-bottom:15px; color:var(--warning);">üí° ƒ∞pucu</h3>
                    <p id="hint-text" style="color:#4B5563; line-height:1.5;"></p>
                    <img id="hint-image" src="" alt="G√∂rsel Yok" onerror="handleImageError(this)">
                    <div id="img-error-msg" style="color:#EF4444; font-size:0.8rem; margin-top:5px; display:none;"></div>
                    <button class="btn" style="padding: 10px 25px; font-size: 0.95rem; margin-top:20px;" onclick="closeHint()">Tamam</button>
                </div>
            </div>
            
            <!-- CEVABI G√ñR ONAY MODALI -->
            <div id="answer-confirm-modal" class="modal-overlay">
                <div class="modal-content">
                    <h3 style="margin-bottom:15px; color:var(--secondary);">üëÅÔ∏è Cevabƒ± G√∂ster</h3>
                    <p style="color:#666; margin-bottom:25px;">Bu sorunun doƒüru cevabƒ±nƒ± g√∂rmek istediƒüinize emin misiniz?<br><small style="color:#EF4444; font-weight:bold; display:block; margin-top:5px;">(Cevabƒ± g√∂r√ºrseniz bu soru BO≈û sayƒ±lacaktƒ±r)</small></p>
                    <button class="btn" style="background-color:var(--secondary);" onclick="revealAnswer()">Evet, G√∂ster</button>
                    <button class="btn" style="background-color:white; color:#374151; border:1px solid #d1d5db; margin-top:10px" onclick="closeAnswerModal()">Vazge√ß</button>
                </div>
            </div>

            <!-- S√úRE SE√áƒ∞M MODALI -->
            <div id="timer-modal" class="modal-overlay">
                <div class="modal-content">
                    <h3 style="color:var(--text);">‚è±Ô∏è S√ºre Tercihi</h3>
                    <p style="color:#666; margin-bottom:25px;">Bu testte s√ºre tutulmasƒ±nƒ± ister misin?</p>
                    <button class="btn" onclick="confirmStart(true)">Evet, S√ºre Olsun</button>
                    <button class="btn" style="background-color:#E5E7EB; color:#374151; margin-top:10px" onclick="confirmStart(false)">Hayƒ±r, S√ºresiz Mod</button>
                </div>
            </div>

            <!-- Bƒ∞Tƒ∞RME UYARI MODALI -->
            <div id="finish-warning-modal" class="modal-overlay">
                <div class="modal-content">
                    <h3 style="color:#DC2626;">‚ö†Ô∏è Dikkat!</h3>
                    <p style="color:#666; margin-bottom:25px;">Hen√ºz cevaplamadƒ±ƒüƒ±nƒ±z bo≈ü sorular var. Yine de sƒ±navƒ± bitirmek istiyor musunuz?</p>
                    <button class="btn" style="background-color:#EF4444;" onclick="finishExamForce()">Evet, Sƒ±navƒ± Bitir</button>
                    <button class="btn" style="background-color:white; color:#374151; border:1px solid #d1d5db; margin-top:10px" onclick="goToFirstEmpty()">Bo≈ü Sorulara D√∂n</button>
                </div>
            </div>

            <!-- ANA MEN√ú √áIKI≈û ONAY MODALI -->
            <div id="home-confirm-modal" class="modal-overlay">
                <div class="modal-content">
                    <h3>‚ö†Ô∏è √áƒ±kƒ±≈ü Yap</h3>
                    <p style="color:#666; margin-bottom:25px;">Sƒ±navƒ± yarƒ±da bƒ±rakƒ±p ana men√ºye d√∂nmek istediƒüinize emin misiniz? ƒ∞lerlemeniz kaybolacak.</p>
                    <button class="btn" style="background-color:#EF4444;" onclick="goHomeForce()">Evet, √áƒ±k</button>
                    <button class="btn" style="background-color:white; color:#374151; border:1px solid #d1d5db; margin-top:10px" onclick="closeHomeModal()">Vazge√ß</button>
                </div>
            </div>

        </div>
    </div>

    <!-- YENƒ∞ FOOTER -->
    <footer class="site-footer">
        <div>LGS Hazƒ±rlƒ±k Portalƒ±</div>
        <div style="margin-top:5px; font-size:0.85rem; color:#9CA3AF;">Ba≈üarƒ±, her g√ºn tekrarlanan k√º√ß√ºk √ßabalarƒ±n toplamƒ±dƒ±r.</div>
    </footer>

    <script>
        // --- AYARLAR ---
        const SHEET_ID = "2PACX-1vRpQT51KZk-RD0zVwuobsm-5Cyofh5x-Z6AAUBQQ_GOH7rOc4KgKuFtkBw7lntpIaaRClcY5Hngf27R";
        const timeStamp = new Date().getTime(); 
        const SHEET_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?output=csv&gid=0&v=${timeStamp}`;

        // *** GOOGLE CLOUD BUCKET AYARI ***
        const GCS_BUCKET_NAME = "lgs-resim-deposu"; 
        const BASE_IMG_URL = `https://storage.googleapis.com/${GCS_BUCKET_NAME}`;

        // Proxy Sƒ±ralamasƒ±
        const PROXIES = [
            `https://corsproxy.io/?${encodeURIComponent(SHEET_CSV_URL)}`,
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(SHEET_CSV_URL)}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(SHEET_CSV_URL)}`
        ];
        
        // DERS ƒ∞Sƒ∞MLERƒ∞ S√ñZL√úƒû√ú (Global)
        const LESSON_NAMES = {
            'matematik': 'üìê Matematik', 'turkce': 'üìö T√ºrk√ße', 'fen': 'üß¨ Fen Bilimleri',
            'fenbilimleri': 'üß¨ Fen Bilimleri', 'inkilap': 'üáπüá∑ ƒ∞nkƒ±lap Tarihi ve Atat√ºrk√ß√ºl√ºk',
            'inkilaptarihi': 'üáπüá∑ ƒ∞nkƒ±lap Tarihi ve Atat√ºrk√ß√ºl√ºk',
            'inkilaptarihiveataturkculuk': 'üáπüá∑ ƒ∞nkƒ±lap Tarihi ve Atat√ºrk√ß√ºl√ºk',
            'ingilizce': 'üá¨üáß ƒ∞ngilizce',
            'din': 'üïå Din K√ºlt√ºr√º ve Ahlak Bilgisi',
            'dinkulturu': 'üïå Din K√ºlt√ºr√º ve Ahlak Bilgisi',
            'dinkulturuveahlakbilgisi': 'üïå Din K√ºlt√ºr√º ve Ahlak Bilgisi'
        };

        // --- DEƒûƒ∞≈ûKENLER ---
        let allQuestions = [];
        let currentQuestions = [];
        let userAnswers = []; 
        let currentIndex = 0;
        let score = 0;
        let timer;
        let timeLeft;
        let isTimerRunning = false;
        
        let selectedLesson = null;
        let isTimerEnabled = true;
        let isGeneralExam = false; 
        
        let isReviewMode = false;
        let isSequentialReview = false; 
        let wrongQuestionIndices = []; 
        let reviewStep = 0; 
        
        // Konu Se√ßimi ƒ∞√ßin Ge√ßici Liste
        let pendingQuestions = [];
        let quizMode = 'lesson'; // 'lesson', 'general', 'topic'

        // --- BA≈ûLANGI√á ---
        window.onload = function() { tryFetchData(0); };

        function tryFetchData(proxyIndex) {
            const statusText = document.getElementById('status-text');
            const errorLog = document.getElementById('error-log');

            if (proxyIndex >= PROXIES.length) {
                statusText.innerText = "Baƒülantƒ± kurulamadƒ±. L√ºtfen internetinizi kontrol edin.";
                statusText.style.color = "red";
                statusText.style.animation = "none";
                document.getElementById('retry-btn').style.display = 'inline-block';
                document.getElementById('demo-btn').style.display = 'inline-block';
                return;
            }

            // Temiz Y√ºkleme Mesajƒ±
            statusText.innerText = "Sorular Y√ºkleniyor...";
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); 

            fetch(PROXIES[proxyIndex], { signal: controller.signal })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(csvText => {
                    const questions = parseCSV(csvText);
                    if (questions.length > 0) {
                        allQuestions = questions;
                        initApp();
                    } else {
                        throw new Error("Veri bo≈ü veya format hatalƒ±.");
                    }
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    console.warn(`Proxy ${proxyIndex} hatasƒ±:`, err);
                    tryFetchData(proxyIndex + 1);
                });
        }

        // --- METƒ∞N FORMATLAYICI ---
        function formatText(str) {
            if (!str) return "";
            str = str.replace(/\$/g, ""); 
            str = str.replace(/\\le(q)?(?![a-zA-Z])/g, "‚â§"); 
            str = str.replace(/\\ge(q)?(?![a-zA-Z])/g, "‚â•"); 
            str = str.replace(/\\neq(?![a-zA-Z])/g, "‚â†");
            str = str.replace(/\\approx(?![a-zA-Z])/g, "‚âà");
            str = str.replace(/\\cdot(?![a-zA-Z])/g, "¬∑");
            str = str.replace(/\\times(?![a-zA-Z])/g, "√ó");
            str = str.replace(/\\div(?![a-zA-Z])/g, "√∑");
            str = str.replace(/\\pi(?![a-zA-Z])/g, "œÄ");
            str = str.replace(/\\deg(?![a-zA-Z])/g, "¬∞");
            
            str = str.replace(/\\sqrt\{([^}]+)\}/g, '<span style="white-space: nowrap;">&radic;<span style="text-decoration: overline;">$1</span></span>');
            str = str.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '<span style="display: inline-block; vertical-align: middle; text-align: center; font-size: 0.9em; margin: 0 2px;"><span style="display: block; border-bottom: 1px solid currentColor; padding: 0 2px;">$1</span><span style="display: block; padding: 0 2px;">$2</span></span>');

            str = str.replace(/_\{([^}]+)\}/g, "<sub>$1</sub>");
            str = str.replace(/_([0-9]+)/g, "<sub>$1</sub>");
            str = str.replace(/\^\{([^}]+)\}/g, "<sup>$1</sup>");
            str = str.replace(/\^([0-9]+)/g, "<sup>$1</sup>");
            str = str.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
            return str;
        }

        // --- CSV AYRI≈ûTIRICI ---
        function parseCSV(text) {
            if (!text || text.length < 10) return [];
            const rawLines = text.trim().split(/\r\n|\n|\r/);
            const lines = [];
            let buffer = "";
            for (let i = 0; i < rawLines.length; i++) {
                let line = rawLines[i];
                if (buffer) buffer += "\n" + line; else buffer = line;
                const quoteCount = (buffer.match(/"/g) || []).length;
                if (quoteCount % 2 === 0) { lines.push(buffer); buffer = ""; }
            }
            const result = [];
            let lastValidLessonSlug = "genel"; 
            let lastValidLessonDisplay = "Genel";

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i];
                if (!row || row.length < 5) continue; 
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const clean = cols.map(c => {
                    if (!c) return "";
                    let val = c.trim();
                    if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1).replace(/""/g, '"');
                    return val;
                });
                if (clean.length < 3 || !clean[2]) continue;

                let rawLesson = clean[1] || "";
                let lessonSlug = "";
                let displayLesson = "";
                if (!isNaN(rawLesson) && rawLesson.trim().length < 5) {
                    lessonSlug = lastValidLessonSlug;
                    displayLesson = lastValidLessonDisplay;
                } else {
                    let cleanLessonName = rawLesson.replace(/[\u200B-\u200D\uFEFF]/g, '').trim();
                    lessonSlug = cleanLessonName.toLocaleLowerCase('tr-TR')
                                          .replace(/ƒ±/g, 'i').replace(/≈ü/g, 's').replace(/ƒü/g, 'g')
                                          .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                                          .replace(/[^a-z0-9]/g, ''); 
                    
                    if (lessonSlug.includes('inkilap')) lessonSlug = 'inkilap';
                    if (lessonSlug.includes('dinkulturu') || lessonSlug.includes('dinve')) lessonSlug = 'din';
                    if (lessonSlug === 'fenbilimleri') lessonSlug = 'fen';

                    displayLesson = rawLesson;
                    if (lessonSlug.length > 2) {
                        lastValidLessonSlug = lessonSlug;
                        lastValidLessonDisplay = rawLesson;
                    }
                }
                
                let imgId = clean[9] ? clean[9].trim() : ""; 
                let rawHint = clean[10] ? clean[10].trim() : "";
                let rawSource = clean[11] ? clean[11].trim() : "";
                
                // YENƒ∞: M S√ºtunu (13. S√ºtun, index 12) = Konu Bilgisi
                let rawTopic = clean[12] ? clean[12].trim() : "Genel";
                
                if (!imgId) imgId = clean[0]; 

                let finalHintText = formatText(rawHint); 
                let imgPath = `${BASE_IMG_URL}/Soru_${lessonSlug}_${imgId}.png`;

                let formattedText = formatText(clean[2]);
                let formattedOptions = [
                    formatText(clean[3] || "A"), 
                    formatText(clean[4] || "B"), 
                    formatText(clean[5] || "C"), 
                    formatText(clean[6] || "D")
                ];

                result.push({
                    id: clean[0], 
                    imgNo: imgId, 
                    lesson: lessonSlug, 
                    lessonDisplay: displayLesson, 
                    topic: rawTopic, // Konu bilgisi eklendi
                    text: formattedText,
                    source: rawSource, 
                    options: formattedOptions,
                    correct: parseInt(clean[7]) || 0,
                    time: parseInt(clean[8]) || 60,
                    hintText: finalHintText,
                    hintImage: imgPath,
                    points: 10
                });
            }
            return result;
        }

        // --- UYGULAMA BA≈ûLATMA ---
        function initApp() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('home-screen').classList.add('active');
            document.getElementById('total-q-count').innerText = allQuestions.length;

            const subjects = [...new Set(allQuestions.map(q => q.lesson))];
            const btnContainer = document.getElementById('subject-buttons');
            btnContainer.innerHTML = '';

            subjects.forEach(subj => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-subject';
                if (subj.includes("hata")) {
                    btn.style.backgroundColor = "#fee2e2"; btn.style.color = "#dc2626"; btn.style.borderColor = "#dc2626";
                    const originalQ = allQuestions.find(q => q.lesson === subj);
                    btn.innerText = originalQ ? originalQ.lessonDisplay : subj;
                } else {
                    btn.innerText = LESSON_NAMES[subj] || subj.toUpperCase();
                }
                btn.onclick = () => preStartQuiz(subj);
                btnContainer.appendChild(btn);
            });
        }

        // --- KONU SE√áƒ∞M FONKSƒ∞YONLARI (YENƒ∞) ---
        function openTopicSelection() {
            // Konularƒ± derslere g√∂re grupla
            const topicsByLesson = {};
            
            allQuestions.forEach(q => {
                if (!topicsByLesson[q.lesson]) {
                    topicsByLesson[q.lesson] = new Set();
                }
                if (q.topic && q.topic !== "Genel") {
                     topicsByLesson[q.lesson].add(q.topic);
                }
            });

            const container = document.getElementById('topic-list-container');
            container.innerHTML = '';

            for (const [lesson, topicsSet] of Object.entries(topicsByLesson)) {
                if (topicsSet.size === 0) continue;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'topic-group';
                
                const title = document.createElement('h3');
                title.innerText = LESSON_NAMES[lesson] || lesson.toUpperCase();
                groupDiv.appendChild(title);

                topicsSet.forEach(topic => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'topic-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = topic;
                    checkbox.dataset.lesson = lesson;
                    checkbox.id = `topic-${lesson}-${topic.replace(/\s+/g, '-')}`;

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.innerText = topic;

                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    groupDiv.appendChild(itemDiv);
                });

                container.appendChild(groupDiv);
            }

            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('topic-selection-screen').classList.add('active');
        }

        function prepareTopicQuiz() {
            const checkboxes = document.querySelectorAll('#topic-list-container input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("L√ºtfen en az bir konu se√ßiniz.");
                return;
            }

            const selectedCriteria = Array.from(checkboxes).map(cb => ({
                lesson: cb.dataset.lesson,
                topic: cb.value
            }));

            // Sorularƒ± filtrele
            pendingQuestions = allQuestions.filter(q => {
                return selectedCriteria.some(criteria => 
                    q.lesson === criteria.lesson && q.topic === criteria.topic
                );
            });

            if (pendingQuestions.length === 0) {
                alert("Se√ßilen konularda soru bulunamadƒ±.");
                return;
            }

            // Karƒ±≈ütƒ±r
            pendingQuestions.sort(() => Math.random() - 0.5);

            quizMode = 'topic';
            document.getElementById('topic-selection-screen').classList.remove('active');
            document.getElementById('timer-modal').style.display = 'flex';
        }

        // --- SINAV MODLARI VE BA≈ûLATMA ---

        function startGeneralExam() {
            quizMode = 'general';
            isReviewMode = false;
            currentQuestions = [];

            const distribution = {
                'matematik': 20, 'fen': 20, 'turkce': 20, 'din': 10, 'inkilap': 10, 'ingilizce': 10
            };

            for (let [subj, count] of Object.entries(distribution)) {
                let pool = allQuestions.filter(q => {
                    if (subj === 'matematik') return q.lesson === 'matematik';
                    if (subj === 'turkce') return q.lesson === 'turkce';
                    if (subj === 'fen') return q.lesson === 'fen' || q.lesson === 'fenbilimleri';
                    if (subj === 'din') return q.lesson === 'din' || q.lesson.includes('din');
                    if (subj === 'inkilap') return q.lesson.includes('inkilap');
                    if (subj === 'ingilizce') return q.lesson === 'ingilizce';
                    return false;
                });
                pool.sort(() => Math.random() - 0.5);
                currentQuestions = currentQuestions.concat(pool.slice(0, Math.min(pool.length, count)));
            }
            
            if (currentQuestions.length === 0) {
                alert("Yeterli soru bulunamadƒ±. L√ºtfen tabloyu kontrol edin.");
                return;
            }

            isGeneralExam = true;
            timeLeft = 155 * 60;
            isTimerEnabled = true; 
            
            initializeQuiz();
            startGlobalTimer(); 
        }

        function preStartQuiz(lesson) {
            quizMode = 'lesson';
            selectedLesson = lesson;
            document.getElementById('timer-modal').style.display = 'flex';
        }

        function confirmStart(enableTimer) {
            isTimerEnabled = enableTimer;
            document.getElementById('timer-modal').style.display = 'none';
            
            if (quizMode === 'lesson') {
                currentQuestions = allQuestions.filter(q => q.lesson === selectedLesson);
                if (currentQuestions.length === 0) {
                    alert("Bu ders i√ßin soru bulunamadƒ±.");
                    return;
                }
                isGeneralExam = false;
                initializeQuiz();
            } else if (quizMode === 'topic') {
                currentQuestions = pendingQuestions;
                isGeneralExam = false;
                initializeQuiz();
            }
        }

        // Ortak Sƒ±nav Ba≈ülatma Fonksiyonu
        function initializeQuiz() {
            // VERƒ∞ YAPISI G√úNCELLEMESƒ∞: Array obje tutacak
            userAnswers = new Array(currentQuestions.length).fill(null);
            currentIndex = 0; score = 0;
            
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('topic-selection-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            document.getElementById('result-screen').classList.remove('active');
            
            document.getElementById('review-banner').style.display = 'none';
            document.getElementById('score-display').parentElement.style.visibility = 'hidden';
            document.getElementById('back-to-results-btn').style.display = 'none';
            document.getElementById('btn-finish-exam').style.display = 'block';
            document.getElementById('next-btn').innerText = "Sonraki ‚û°Ô∏è";
            
            loadQuestion();
        }

        function loadQuestion() {
            let qIndex = currentIndex;
            // ƒ∞NCELEME MODU KONTROLLERƒ∞
            if (isReviewMode && isSequentialReview) {
                if (!wrongQuestionIndices || wrongQuestionIndices.length === 0 || reviewStep >= wrongQuestionIndices.length) {
                    returnToResults();
                    return;
                }
                qIndex = wrongQuestionIndices[reviewStep];
            } else if (isReviewMode) {
                qIndex = currentIndex;
            }

            // G√úVENLƒ∞K KONTROL√ú
            const q = currentQuestions[qIndex];
            if (!q) {
                console.error("Soru y√ºklenemedi! ƒ∞ndeks:", qIndex);
                alert("Bir hata olu≈ütu, soru y√ºklenemedi. Ana men√ºye d√∂n√ºl√ºyor.");
                goHome();
                return;
            }

            const answerData = userAnswers[qIndex]; 
            let selectedIdx = null;
            let isViewed = false;

            if (answerData) {
                selectedIdx = answerData.selected;
                isViewed = answerData.viewedAnswer;
            }

            let questionLabel;
            if (isReviewMode && isSequentialReview) {
                 questionLabel = `[Yanlƒ±≈ü Soru ${reviewStep + 1}/${wrongQuestionIndices.length}] `;
            } else if (isReviewMode) {
                 questionLabel = `[ƒ∞nceleme: Soru ${qIndex + 1}] `;
            } else {
                 questionLabel = `${qIndex + 1}) `;
            }
            
            let qTextHTML = q.text || ""; 
            
            const imgPath = `${BASE_IMG_URL}/Soruici_${q.lesson}_${q.imgNo}.png`;
            const imgTag = `<img src="${imgPath}" class="question-inner-img" style="display:block; margin: 10px auto;" onerror="this.style.display='none'">`;

            if (qTextHTML.includes('[Gorsel]')) {
                qTextHTML = qTextHTML.replace('[Gorsel]', imgTag);
                document.getElementById('question-inner-img').style.display = 'none';
            } else {
                const innerImg = document.getElementById('question-inner-img');
                innerImg.style.display = 'none'; 
                innerImg.src = imgPath;
                innerImg.onload = function() { this.style.display = 'block'; }; 
                innerImg.onerror = function() { this.style.display = 'none'; }; 
            }

            document.getElementById('question-text').innerHTML = questionLabel + qTextHTML;
            document.getElementById('question-source').innerText = q.source || "";

            if (!isGeneralExam && isTimerEnabled && !isReviewMode) {
                timeLeft = q.time; 
                startTimer(); 
                updateTimerDisplay();
                document.getElementById('time-display').style.visibility = 'visible';
            } else if (isGeneralExam) {
                updateTimerDisplay();
                document.getElementById('time-display').style.visibility = 'visible';
            } else {
                clearInterval(timer);
                document.getElementById('time-display').style.visibility = 'hidden';
            }
            
            const total = (isReviewMode && isSequentialReview) ? wrongQuestionIndices.length : currentQuestions.length;
            const current = (isReviewMode && isSequentialReview) ? reviewStep : qIndex;
            const percent = total > 0 ? (current / total) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${percent}%`;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            const letters = ['A', 'B', 'C', 'D'];
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                // GCS URL Formatƒ±
                const optImgPath = `${BASE_IMG_URL}/Sorusik_${q.lesson}_${q.imgNo}_${letters[idx]}.png`;
                const imgEl = document.createElement('img');
                imgEl.src = optImgPath;
                imgEl.onload = function() { this.style.display = 'block'; }; 
                imgEl.onerror = function() { this.style.display = 'none'; }; 
                btn.appendChild(imgEl);
                const textSpan = document.createElement('span');
                textSpan.innerHTML = letters[idx] + ") " + opt; 
                btn.appendChild(textSpan);
                
                // Cevap G√∂r√ºld√º veya ƒ∞nceleme Modu
                if (isReviewMode || isViewed) {
                    btn.disabled = true;
                    if (idx === q.correct) btn.classList.add('correct-review');
                    if (selectedIdx === idx && idx !== q.correct) btn.classList.add('wrong-review');
                } else {
                    if (selectedIdx === idx) btn.classList.add('selected');
                    btn.onclick = () => selectAnswer(qIndex, idx);
                }
                container.appendChild(btn);
            });

            const hintTextEl = document.getElementById('hint-text');
            const hintImgEl = document.getElementById('hint-image');
            const errorMsgEl = document.getElementById('img-error-msg');
            
            hintTextEl.innerText = q.hintText;
            hintTextEl.style.display = q.hintText ? "block" : "none";
            
            hintImgEl.style.display = "block";
            hintImgEl.removeAttribute('data-tried-root'); 
            errorMsgEl.style.display = 'none';
            hintImgEl.src = q.hintImage;

            // Navigation state check
            const isFirst = (isReviewMode && isSequentialReview) ? (reviewStep === 0) : (qIndex === 0);
            const isLast = (isReviewMode && isSequentialReview) ? (reviewStep === wrongQuestionIndices.length - 1) : (qIndex === currentQuestions.length - 1);
            
            document.getElementById('prev-btn').disabled = isFirst;
            
            let nextText = "Sonraki ‚û°Ô∏è";
            if (isLast) {
                if(isReviewMode) nextText = "Sonu√ßlara D√∂n";
                else nextText = "Sƒ±navƒ± Bitir üèÅ"; 
            }
            document.getElementById('next-btn').innerText = nextText;
        }

        function handleImageError(img) {
            img.style.display = 'none';
        }

        function startGlobalTimer() {
            if (timer) clearInterval(timer);
            isTimerRunning = true;
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(); 
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    isTimerRunning = false;
                    alert("S√ºre Doldu! Sƒ±nav otomatik bitiriliyor.");
                    endQuiz();
                }
            }, 1000);
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            isTimerRunning = true;
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    isTimerRunning = false;
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const h = Math.floor(timeLeft / 3600);
            const m = Math.floor((timeLeft % 3600) / 60);
            const s = timeLeft % 60;
            
            let display = "";
            if (h > 0) display += (h < 10 ? "0" + h : h) + ":";
            display += (m < 10 ? "0" + m : m) + ":";
            display += (s < 10 ? "0" + s : s);
            
            document.getElementById('time-display').innerText = display;
        }

        function selectAnswer(qIndex, idx) {
            // Mevcut veriyi al veya yeni olu≈ütur
            let currentAns = userAnswers[qIndex] || { viewedAnswer: false };
            currentAns.selected = idx;
            userAnswers[qIndex] = currentAns;

            const buttons = document.querySelectorAll('.btn-option');
            buttons.forEach((b, i) => {
                b.classList.remove('selected');
                if (i === idx) b.classList.add('selected');
            });
        }

        function prevQuestion() {
            if (isReviewMode && isSequentialReview) {
                if (reviewStep > 0) { reviewStep--; loadQuestion(); }
            } else {
                if (currentIndex > 0) { currentIndex--; loadQuestion(); }
            }
        }

        function nextQuestion() {
            if (isReviewMode && isSequentialReview) {
                if (reviewStep < wrongQuestionIndices.length - 1) { reviewStep++; loadQuestion(); }
                else {
                    returnToResults();
                }
            } else {
                if (currentIndex < currentQuestions.length - 1) { currentIndex++; loadQuestion(); }
                else checkFinish();
            }
        }

        function checkFinish() {
            const hasEmpty = userAnswers.some(ans => !ans || (ans.selected === null || ans.selected === undefined) && !ans.viewedAnswer);
            
            if (hasEmpty) document.getElementById('finish-warning-modal').style.display = 'flex';
            else endQuiz();
        }

        function goToFirstEmpty() {
            document.getElementById('finish-warning-modal').style.display = 'none';
            const firstEmptyIndex = userAnswers.findIndex(ans => !ans || (ans.selected === null || ans.selected === undefined) && !ans.viewedAnswer);
            if (firstEmptyIndex !== -1) { currentIndex = firstEmptyIndex; loadQuestion(); }
        }

        function finishExamForce() {
            document.getElementById('finish-warning-modal').style.display = 'none';
            endQuiz();
        }

        function endQuiz() {
            clearInterval(timer);
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            
            let correctCount = 0; let wrongCount = 0; let emptyCount = 0;
            score = 0;
            wrongQuestionIndices = []; 

            const listContainer = document.getElementById('result-list-container');
            listContainer.innerHTML = ''; 

            userAnswers.forEach((ans, index) => {
                const q = currentQuestions[index];
                
                const item = document.createElement('div');
                item.className = 'q-result-item';
                item.innerText = index + 1;
                item.onclick = () => enterReviewMode(index); 

                // ans null olabilir veya obje olabilir
                let selectedIdx = (ans && ans.selected !== undefined) ? ans.selected : null;
                let isViewed = (ans && ans.viewedAnswer) ? true : false;

                // Bo≈ü veya G√∂r√ºld√º ise Puan Yok
                if (selectedIdx === null || isViewed) {
                    emptyCount++;
                    item.classList.add('empty');
                } else if (selectedIdx === q.correct) {
                    correctCount++;
                    score += q.points;
                    item.classList.add('correct');
                } else {
                    wrongCount++;
                    item.classList.add('wrong');
                    wrongQuestionIndices.push(index); 
                }
                listContainer.appendChild(item);
            });

            document.getElementById('res-correct').innerText = correctCount;
            document.getElementById('res-wrong').innerText = wrongCount;
            document.getElementById('res-empty').innerText = emptyCount;
            document.getElementById('final-score').innerText = score;
            
            const wrongBox = document.getElementById('wrong-box');
            if (wrongCount > 0) {
                wrongBox.onclick = startReview; 
                wrongBox.style.cursor = "pointer";
            } else {
                wrongBox.onclick = null;
                wrongBox.style.cursor = "default";
            }

            const msg = document.getElementById('feedback-text');
            if (score > (currentQuestions.length * 8)) msg.innerText = "Harika ƒ∞≈ü! üéâ";
            else msg.innerText = "Sƒ±nav Bitti. Sonu√ßlarƒ±nƒ± kontrol et.";
        }

        function enterReviewMode(index) {
            isReviewMode = true;
            isSequentialReview = false; 
            currentIndex = index; 
            
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            
            document.getElementById('review-banner').style.display = 'block';
            document.getElementById('back-to-results-btn').style.display = 'block';
            document.getElementById('btn-finish-exam').style.display = 'none'; 
            
            loadQuestion();
        }

        function startReview() {
            if (wrongQuestionIndices.length === 0) return;
            isReviewMode = true;
            isSequentialReview = true; 
            reviewStep = 0;
            
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            
            document.getElementById('review-banner').style.display = 'block';
            document.getElementById('back-to-results-btn').style.display = 'block';
            document.getElementById('btn-finish-exam').style.display = 'none';
            
            loadQuestion();
        }

        function returnToResults() {
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
        }

        function openAnswerModal() {
             document.getElementById('answer-confirm-modal').style.display = 'flex';
        }
        
        function closeAnswerModal() {
             document.getElementById('answer-confirm-modal').style.display = 'none';
        }
        
        function revealAnswer() {
            closeAnswerModal();
            // Mevcut se√ßimi koru, sadece viewedAnswer true yap
            let currentAns = userAnswers[currentIndex] || { selected: null };
            currentAns.viewedAnswer = true;
            userAnswers[currentIndex] = currentAns;
            
            loadQuestion(); 
        }

        function openHomeModal() {
            document.getElementById('home-confirm-modal').style.display = 'flex';
        }

        function closeHomeModal() {
            document.getElementById('home-confirm-modal').style.display = 'none';
        }

        function goHomeForce() {
            closeHomeModal();
            goHome();
        }

        function goHome() {
            clearInterval(timer); isReviewMode = false;
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('home-screen').classList.add('active');
            document.getElementById('topic-selection-screen').classList.remove('active');
        }
        
        function showHint() { document.getElementById('hint-modal').style.display = 'flex'; }
        function closeHint() { document.getElementById('hint-modal').style.display = 'none'; }

        function useDemoData() {
            allQuestions = [
                { lesson: 'matematik', text: 'DEMO: 12 x 12 = ?', options: ['124','144','156','160'], correct: 1, time: 30, hintText: 'Sonu 4 ile bitmeli', hintImage: '', points: 10 },
                { lesson: 'turkce', text: 'DEMO: Zƒ±t anlamlƒ± kelime √ßifti hangisidir?', options: ['Ak-Beyaz','Siyah-Kara','ƒ∞leri-Geri','Okul-Mektep'], correct: 2, time: 30, hintText: 'Birbirinin tersi olmalƒ±', hintImage: '', points: 10 }
            ];
            initApp();
        }
    </script>
</body>
</html>
